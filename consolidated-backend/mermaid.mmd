erDiagram
    %% ------------------------
    %% USERS & AUTH
    %% ------------------------
    USER {
        string user_id PK
        string name
        string email
        string phone
        datetime created_at
    }

    USER_AUTH {
        int auth_id PK
        string user_id FK
        enum auth_type "email | phone | google | facebook | apple"
        string identifier
        string secret_hash
        datetime created_at
    }

    USER_SESSION {
        int session_id PK
        string user_id FK
        string jti
        string refresh_token
        datetime issued_at
        datetime expires_at
        boolean is_active
    }

    GUEST {
        int guest_id PK
        string session_id "unique guest session identifier"
        string ip_address
        string user_agent
        string device_fingerprint
        datetime expires_at
        boolean is_active
        datetime created_at
        datetime last_activity
    }

    %% ------------------------
    %% RBAC WITH FEATURE/ACTION
    %% ------------------------
    ROLE {
        int role_id PK
        string name
        string description
    }

    FEATURE {
        int feature_id PK
        string name "gig, bid, dispute, payment"
        string description
    }

    ACTION {
        int action_id PK
        string name "read, write, update, delete, resolve"
        string description
    }

    PERMISSION {
        int permission_id PK
        int feature_id FK
        int action_id FK
        string code "gig:read, gig:write, dispute:resolve"
    }

    ROLE_PERMISSION {
        int role_id FK
        int permission_id FK
    }

    USER_ROLE {
        int user_role_id PK
        string user_id FK
        int role_id FK
    }

    GUEST_ROLE {
        int guest_role_id PK
        int guest_id FK
        int role_id FK
    }

    %% ------------------------
    %% SUBSCRIPTIONS
    %% ------------------------
    SUBSCRIPTION_PLAN {
        int plan_id PK
        string name "Free, Gold, Platinum"
        string description
        float price
        enum billing_cycle "monthly | yearly"
        boolean is_active
    }

    SUBSCRIPTION {
        int subscription_id PK
        string user_id FK
        int plan_id FK
        datetime start_date
        datetime end_date
        enum status "active | expired | cancelled"
    }

    PLAN_PERMISSION {
        int plan_id FK
        int permission_id FK
    }

    %% ------------------------
    %% HOMEOWNER & PROVIDER
    %% ------------------------
    HOMEOWNER {
        int homeowner_id PK
        string user_id FK
    }

    SERVICE_PROVIDER {
        int provider_id PK
        string user_id FK
        string business_name
        string license_number
        enum verification_status "unverified | pending | verified | rejected"
    }

    %% ------------------------
    %% ADDRESS
    %% ------------------------
    ADDRESS {
        int address_id PK
        int homeowner_id FK
        string line1
        string line2
        string city
        string state
        string postal_code
        string country
        float latitude
        float longitude
    }

    %% ------------------------
    %% SERVICE TAXONOMY (NEW)
    %% ------------------------
    SERVICE_CATEGORY {
        int category_id PK
        string code
        string name
        string icon
        string description
        boolean is_active
    }

    SERVICE_CATEGORY_LOCALE {
        int id PK
        int category_id FK
        string locale "e.g., en_US, fr_FR"
        string display_name
        string description
        %% UNIQUE(category_id, locale) recommended
    }

    SERVICE_SUBCATEGORY {
        int subcategory_id PK
        int category_id FK
        string code
        string name
        string description
        boolean is_active
    }

    SERVICE_SUBCATEGORY_LOCALE {
        int id PK
        int subcategory_id FK
        string locale "e.g., en_US, fr_FR"
        string display_name
        string description
        %% UNIQUE(subcategory_id, locale) recommended
    }

    %% ------------------------
    %% TAGGING (NEW)
    %% ------------------------
    TAG {
        int tag_id PK
        string name
        string slug
        string description
        boolean is_active
    }

    TAG_LOCALE {
        int id PK
        int tag_id FK
        string locale "e.g., en_US, fr_FR"
        string display_name
        string description
        %% UNIQUE(tag_id, locale) recommended
    }


    SERVICE_CATEGORY_TAG {
        int category_id FK
        int tag_id FK
    }

    SERVICE_SUBCATEGORY_TAG {
        int subcategory_id FK
        int tag_id FK
    }

    PROVIDER_TAG {
        int provider_id FK
        int tag_id FK
    }

    GIG_TAG {
        int gig_id FK
        int tag_id FK
    }

    %% ------------------------
    %% GIG REQUEST  (nullable address_id + snapshots; subcategory support)
    %% ------------------------
    GIG_REQUEST {
        int gig_id PK
        int homeowner_id FK
        int category_id FK
        int subcategory_id FK "NULLABLE; ON DELETE SET NULL"
        int address_id FK "NULLABLE; ON DELETE SET NULL"
        string description
        enum urgency "low | medium | high"
        float budget
        datetime scheduled_date
        string media_urls
        enum visibility "open_bidding | direct_request"
        enum status "posted | in_progress | completed | cancelled | disputed"

        json address_snapshot "full address at post time"
        json category_snapshot "e.g. {code, name} at post time"
        json subcategory_snapshot "e.g. {code, name} at post time"
    }

    GIG_STATUS_HISTORY {
        int history_id PK
        int gig_id FK
        enum event_type 
            "posted | accepted | in_progress | amended | completed | cancelled |
             payment_released | payment_refunded | review_added |
             dispute_raised | dispute_resolved"
        string changed_by FK "user_id"
        string remarks
        datetime changed_at
    }

    %% ------------------------
    %% BIDDING
    %% ------------------------
    BID {
        int bid_id PK
        int gig_id FK
        int provider_id FK
        float bid_amount
        string description
        string estimated_duration "e.g. 1 hour, 2 hours, etc."
        enum status "pending | accepted | rejected | withdrawn"
        datetime created_at
    }

    %% ------------------------
    %% PAYMENTS
    %% ------------------------
    PAYMENT {
        int payment_id PK
        int gig_id FK
        float amount
        enum status "pending | escrow | released | refunded"
        string method
        datetime created_at
    }

    %% ------------------------
    %% RATINGS & REVIEWS
    %% ------------------------
    RATING_REVIEW {
        int review_id PK
        int gig_id FK
        string reviewer_id FK "user_id"
        string reviewee_id FK "user_id"
        int rating "1-5"
        string feedback
        boolean verified_completion
        datetime created_at
    }

    %% ------------------------
    %% DISPUTES
    %% ------------------------
    DISPUTE {
        int dispute_id PK
        int gig_id FK
        string raised_by FK "user_id"
        string reason
        enum status "open | under_review | resolved | rejected"
        datetime created_at
        datetime resolved_at
        string resolution_notes
    }

    %% ------------------------
    %% CERTIFICATIONS
    %% ------------------------
    CERTIFICATION {
        int certification_id PK
        string code "e.g., EPA-608, NABCEP-PV, RPL"
        string name
        string description
        string issuing_body "e.g., EPA, NABCEP, State Board"
        string jurisdiction "country/state/province if applicable"
        enum renewal_cycle "none | annual | biennial | triennial | custom"
        int renewal_months "if renewal_cycle=custom"
        boolean is_active
    }

    PROVIDER_CERTIFICATION {
        int provider_cert_id PK
        int provider_id FK
        int certification_id FK
        string certificate_number
        string attachment_url "proof doc/image URL"
        string issuing_authority "override if different from CERTIFICATION.issuing_body"
        datetime issue_date
        datetime expiry_date
        enum status "pending | verified | expired | revoked"
        string verification_notes
        datetime verified_at
        string verified_by FK "user_id (admin/verifier)"
    }

    CATEGORY_CERTIFICATION_REQ {
        int id PK
        int category_id FK
        int certification_id FK
        enum requirement "required | recommended | optional"
        string notes
    }

    %% ------------------------
    %% MASTER DATA + LOCALES
    %% ------------------------
    MASTER_DATA {
        int id PK
        string scope
        string code
        string display_name
        string parent_scope
        string parent_code
        string description
        boolean is_active
        int sort_order
    }

    MASTER_DATA_LOCALE {
        int id PK
        int master_id FK
        string locale "e.g., en_US, fr_FR"
        string display_name
        string description
        %% UNIQUE(master_id, locale) recommended
    }

    %% ------------------------
    %% RELATIONSHIPS
    %% ------------------------
    USER ||--o{ USER_AUTH : "has"
    USER ||--o{ USER_SESSION : "creates"

    USER ||--o{ USER_ROLE : "assigned"
    ROLE ||--o{ USER_ROLE : "granted"
    GUEST ||--o{ GUEST_ROLE : "assigned"
    ROLE ||--o{ GUEST_ROLE : "granted"
    ROLE ||--o{ ROLE_PERMISSION : "defines"
    PERMISSION ||--o{ ROLE_PERMISSION : "included"

    FEATURE ||--o{ PERMISSION : "scope"
    ACTION ||--o{ PERMISSION : "action"

    USER ||--o{ SUBSCRIPTION : "subscribes"
    SUBSCRIPTION_PLAN ||--o{ SUBSCRIPTION : "used_in"
    SUBSCRIPTION_PLAN ||--o{ PLAN_PERMISSION : "grants"
    PERMISSION ||--o{ PLAN_PERMISSION : "included"

    USER ||--|| HOMEOWNER : "is"
    USER ||--|| SERVICE_PROVIDER : "is"

    HOMEOWNER ||--o{ ADDRESS : "has"
    HOMEOWNER ||--o{ GIG_REQUEST : "creates"

    SERVICE_PROVIDER ||--o{ BID : "submits"
    SERVICE_PROVIDER ||--o{ PROVIDER_TAG : "labeled_by"

    %% Service taxonomy links

    SERVICE_CATEGORY ||--o{ SERVICE_CATEGORY_LOCALE : "localizes"
    SERVICE_SUBCATEGORY ||--o{ SERVICE_SUBCATEGORY_LOCALE : "localizes"
    TAG ||--o{ TAG_LOCALE : "localizes"

    SERVICE_CATEGORY ||--o{ SERVICE_SUBCATEGORY : "groups"
    SERVICE_CATEGORY ||--o{ SERVICE_CATEGORY_TAG : "tagged_by"
    SERVICE_SUBCATEGORY ||--o{ SERVICE_SUBCATEGORY_TAG : "tagged_by"

    %% Tag relations
    TAG ||--o{ SERVICE_CATEGORY_TAG : "applies_to"
    TAG ||--o{ SERVICE_SUBCATEGORY_TAG : "applies_to"
    TAG ||--o{ PROVIDER_TAG : "applies_to"
    TAG ||--o{ GIG_TAG : "applies_to"

    %% Master data locales
    MASTER_DATA ||--o{ MASTER_DATA_LOCALE : "localizes"

    %% Gigs
    GIG_REQUEST ||--o{ BID : "receives"
    GIG_REQUEST ||--o{ GIG_STATUS_HISTORY : "tracks"
    GIG_REQUEST ||--o{ PAYMENT : "linked"
    GIG_REQUEST ||--o{ RATING_REVIEW : "results_in"
    GIG_REQUEST ||--o{ DISPUTE : "may_have"
    GIG_REQUEST }o--|| SERVICE_CATEGORY : "belongs_to"
    GIG_REQUEST }o--|| SERVICE_SUBCATEGORY : "belongs_to (optional)"
    GIG_REQUEST }o--|| ADDRESS : "at (NULLABLE; SET NULL on delete)"
    GIG_REQUEST ||--o{ GIG_TAG : "tagged_by"

    USER ||--o{ RATING_REVIEW : "writes"
    USER ||--o{ DISPUTE : "raises"
    USER ||--o{ GIG_STATUS_HISTORY : "changes"
